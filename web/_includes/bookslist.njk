{% if not booksLimit %}
  {% set booksLimit = books.length %}
{% endif %}

{% if booksReverseList %}
  {% set books = books | reverse %}
{% else %}
  {% set books = books %}
{% endif %}

{% set booksCount = 0 %}
-{% set bookSlug = (book.slug and (book.slug.current or book.slug)) | slug %}
+{# slug must be computed per-item - do not compute here #}

<ol class="booklist" style="counter-reset: start-from {{ books.length + 1 }}">

  {% for book in books %}
    {% if booksCount < booksLimit %}
      {% set currentBook = book %}

+      {# compute a stable slug for this book (prefer slug.current, then slug string, fallback to _id or title) #}
+      {% set _rawSlug = (currentBook.slug and (currentBook.slug.current or currentBook.slug)) or currentBook._id or currentBook.title %}
+      {% if _rawSlug %}
+        {% set bookSlug = _rawSlug | slug %}
+      {% else %}
+        {% set bookSlug = '' %}
+      {% endif %}
+
      {% if currentBook.slug.current in page.url %}
        {% set booksLimit = booksLimit + 1 %}
      {% else %}

        <li class="booklist-item">
          <a href="/books/{{ currentBook.slug.current | slug }}/" aria-label="{{ currentBook.title }}" class="booklist-link">

          {%- if currentBook.cover %}
            <img src="{{ currentBook.cover.url }}" width="130" height="200" alt="{{ currentBook.cover.alt or currentBook.title }}" loading="lazy" view-transition-name="book-cover-{{ currentBook.slug.current }}"/>
          {% endif -%}

          </a>
        </li>

      {% endif %}
    {% endif %}

    {% set booksCount = booksCount + 1 %}
  {% endfor %}

</ol>
